<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <!-- <link href="https://gmpg.org/xfn/11" rel="profile"> -->
  <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge"> -->
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Pietro's website">

  <title>
    Pietro - FFMPEG And Electron
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/style.css" defer>
  <link rel="stylesheet" href="/public/css/post-element-condesed.css" defer>
  <link rel="stylesheet" href="/public/css/dark-mode.css" defer>
  <link rel="stylesheet" href="/public/css/badge.css" defer>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w=="
    crossorigin="anonymous" referrerpolicy="no-referrer" defer />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
    crossorigin="anonymous" referrerpolicy="no-referrer" defer />
  <!-- Syntax highlight  -->
  <link id="prism-css" href="https://unpkg.com/prismjs@1.20.0/themes/prism.css" rel="stylesheet" defer>
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144"
    href="/public/apple-touch-icon-precomposed.png" defer>
  <!-- <link rel="shortcut icon" href="/public/favicon.ico"> -->

  <!-- ////////// Favicon ////////// -->
  <!-- For old IEs -->
  <link rel="shortcut icon" href="/public/favicon.ico/favicon.ico" async>
  <!-- For new browsers - multisize ico  -->
  <link rel="icon" type="image/x-icon" sizes="16x16 32x32" href="/public/favicon.ico/favicon.ico"
    async>
  <!-- For iPad with high-resolution Retina display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/public/favicon.ico/favicon-152.png"
    async>
  <!-- For iPad with high-resolution Retina display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/favicon.ico/favicon-144.png"
    async>
  <!-- For iPhone with high-resolution Retina display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/public/favicon.ico/favicon-120.png"
    async>
  <!-- For iPhone with high-resolution Retina display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/public/favicon.ico/favicon-114.png"
    async>
  <!-- For iPhone 6+ -->
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/public/favicon.ico/favicon-180.png"
    async>
  <!-- For first- and second-generation iPad: -->
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/public/favicon.ico/favicon-72.png"
    async>
  <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
  <link rel="apple-touch-icon-precomposed" href="/public/favicon.ico/favicon-57.png" async>
  <!-- For Old Chrome -->
  <link rel="icon" href="/public/favicon.ico/favicon-32.png" sizes="32x32" async>
  <!-- For IE10 Metro -->
  <meta name="msapplication-TileColor" content="#FFFFFF">
  <meta name="msapplication-TileImage" content="favicon-144.png" async>
  <meta name="theme-color" content="#ffffff">
  <!-- Chrome for Android -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" sizes="192x192" href="/public/favicon.ico/favicon-192.png" async>
  <!-- ////////// Favicons end ////////// -->


  <!--  -->
  <!-- Open graph -->
  <meta property="og:title" content="FFMPEG And Electron">
  <meta property="og:description" content="How to use ffmpeg with the fluent-ffmpeg node library in electron.">
  <meta property="og:type" content="article">
  <meta property="og:image" content="https://www.pietropassarelli.com/img/about/fahrul-razi-BR6lrzCPYPk-unsplash.jpeg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="675" />
  <!-- Twitter -->
  <meta name="twitter:title" content="FFMPEG And Electron">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@pietropassarell">
  <meta name="twitter:description" content="How to use ffmpeg with the fluent-ffmpeg node library in electron.">
  <meta name="twitter:image" content="https://www.pietropassarelli.com/img/about/fahrul-razi-BR6lrzCPYPk-unsplash.jpeg">
  <meta name="twitter:creator" content="@pietropassarell">

  <!--  -->

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-R6JQ09CW0P">
  </script>

  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-R6JQ09CW0P');
  </script>

  

</head>





<body class="default-pages">
  <div class="container">
    <div class="wrapper">
      <header class="header">
        Pietro Passarelli 
        
        <nav class="nav">
    <ul class="menu-list">
        <li>
            <a class="sidebar-nav-item" href="/">
                About</a>
        </li>

        

        <li> <a class="" href="/categories/video">

                
                Videos
                
            </a> </li>
        

        <li> <a class="" href="/categories/tech">

                
                Tech
                
            </a> </li>
        

        <li> <a class="" href="/categories/ttqf">

                
                Tips Tricks & Quick Fix
                
            </a> </li>
        

        <li> <a class="" href="/categories/blog">

                
                Blog
                
            </a> </li>
        


        <li> <a class="sidebar-nav-item" href="https://pietropassarelli.com/photos/" target="_blank"
                rel="noopener noreferrer">
                Photos↗</a>
        </li>
    </ul>
</nav>
      </header>
      <main class="main"> 
        
<div class="post">
	<h1 class="post-title">FFMPEG And Electron </h1>
	<span class="post-date">2017 Nov 16 
		
	</span> 
	
	<br>

	

	<!-- optional gitbook link -->
	

	<!-- project page -->
	
	<!-- social media -->
	

	




	<!-- tech Stack -->
	

	<!-- image -->
	
	<!-- description -->
	
	<br>
	How to use ffmpeg with the fluent-ffmpeg node library in electron.
	
	<hr>

	<!-- content -->
	<p>I was recently asked about how to use <a href="https://www.ffmpeg.org/">ffmpeg</a> with the<a href="https://github.com/fluent-ffmpeg/node-fluent-ffmpeg"> fluent-ffmpeg node library</a> in <a href="https://electron.atom.io/">electron</a>, and I had some notes<a href="https://pietropassarelli.gitbooks.io/autoedit-2-documentation/content/ffmpeg-and-ffprobe-in-electron.html"> in the autoEdit documentation</a> but since they were at some sort of at draft stage I decided to expand more on this here, to make a more clear and comprehensive explanation.</p>
<p>I am going to use the code from the implementation of<a href="https://autoEdit.io"> autoEdit.io</a> as well as an earlier &quot;transcriber prototype&quot; as a concrete example.</p>
<p>For those not familiar with it autoEdit is a text based video editing app for mac os x,<a href="https://autoEdit.io"> check out the website</a> , <a href="https://github.com/OpenNewsLabs/autoEdit_2">README</a> and<a href="https://pietropassarelli.gitbooks.io/autoedit2-user-manual/content/"> user manual </a>for more details.</p>
<h2>What’s what?</h2>
<p>First things first let’s introduce the components will need, to make sure you are familiar with it.</p>
<h3><a href="https://www.ffmpeg.org/"><code>Ffmpeg</code></a></h3>
<blockquote>
<p>A complete, cross-platform solution to record, convert and stream audio and video.</p>
</blockquote>
<p>Very powerful go to option for open source manipulation of audio and video files.</p>
<h3><a href="https://ffmpeg.org/ffprobe.html"><code>ffprobe</code></a></h3>
<blockquote>
<p>ffprobe gathers information from multimedia streams and prints it in human- and machine-readable fashion.</p>
</blockquote>
<p>It basically reads metadata information from audio and video files.</p>
<h3><a href="https://electron.atom.io/">Electron</a></h3>
<blockquote>
<p>Build cross platform desktop apps with JavaScript, HTML, and CSS.</p>
</blockquote>
<p>It basically allows you to package your app wit a custom version of the V8 engine which powers chrome to make it self contained, and if you wish, with the right adjustments, cross platform compatible.</p>
<h3><a href="https://github.com/fluent-ffmpeg/node-fluent-ffmpeg"><code>fluent-ffmpeg</code> node</a></h3>
<p>It’s a library that wraps around the ffmpeg binary and provides an easier interface to run ffmpeg commands while in node. <a href="https://github.com/fluent-ffmpeg/node-fluent-ffmpeg#ffmpeg-and-ffprobe">It also supports running commands for ffprobe</a>.</p>
<h3><code>ffmpeg-static</code></h3>
<blockquote>
<p>ffmpeg static binaries for Mac OSX and Linux and Windows</p>
</blockquote>
<p>In this context<a href="https://github.com/pietrop/ffmpeg-static"> I used a modified version</a>, I’ll describe/explain in more details later. <a href="https://github.com/eugeneware/ffmpeg-static">From the original repository.</a></p>
<h3><code>ffprobe-static</code></h3>
<blockquote>
<p>Static binaries for ffprobe</p>
</blockquote>
<p>Equivalent for ffprobe as described above for ffmpeg. And as above In this context<a href="https://github.com/pietrop/ffprobe-static"> I used a modified version</a>, I’ll describe/explain in more details later. <a href="https://github.com/joshwnj/ffprobe-static">From the original repository.</a></p>
<h3><a href="https://github.com/electron-userland/electron-builder"><code>electron-builder</code></a></h3>
<blockquote>
<p>A complete solution to package and build a ready for distribution Electron app with &quot;auto update&quot; support out of the box <a href="https://electron.build">https://electron.build</a></p>
</blockquote>
<p>Is what we’ll use for packing our code base into an electron app that can be built and distributed to users. For example, for mac os x it can create a dmg or zip file to distrubute the app.</p>
<p>As a side note, if you are using github,<a href="https://help.github.com/articles/creating-releases/"> github releases</a> are a great way to host the packaged app distribution. See <a href="https://www.autoedit.io/">autoEdit</a> example where if you click on &quot;Download Os X app&quot; it <a href="https://github.com/OpenNewsLabs/autoEdit_2/releases">takes you to the releases page.</a></p>
<h3>Node modules</h3>
<p>Last but not least see <a href="https://www.sitepoint.com/understanding-module-exports-exports-node-js/">here more details on using export/require for node modules</a> if you are not familiar with it or need a refresher.</p>
<h2>Electron and FFMPEG</h2>
<p>When using fluent-ffmpeg, ffmpeg (and ffprobe) normally the library assumes that the binary is installed and<a href="https://github.com/fluent-ffmpeg/node-fluent-ffmpeg#ffmpeg-and-ffprobe">/or the path available as an environment variable, as described here</a>.</p>
<p>However, in context like electron, you don’t want to go and interfere with the user's systems configurations too much. For example what if they have another installation of ffmpeg that is slightly different and doesn’t have the dependencies you might need for the one in your app?</p>
<p>So we don’t want to either assume ffmpeg/ffprobe that is installed nor install it on their system as it could lead to conflicts and confusion. Nor do we want to make it as a requirement for the users to have that specific version we might need installed, as ffmpeg/ffprobe can be complicated to install and troubleshoot.</p>
<p><a href="https://github.com/fluent-ffmpeg/node-fluent-ffmpeg#setting-binary-paths-manually">Luckily is possible to set the path to ffmpeg and ffprobe binary</a>.  And that is our preferred choice for packaging ffmpeg inside electron.</p>
<h2>A Simple example: <a href="https://pietropassarelli.com/Transcriber-prototype.html">Transcriber prototype</a></h2>
<p><a href="https://pietropassarelli.com/Transcriber-prototype.html">This was a prototype</a> to test whether users would accept automatically transcribed text, before building the first version of autoEdit 2 on top of IBM Watson STT service.</p>
<p>It’s very simple, you give it an audio or video file and it returns a plain text automated transcription.</p>
<p>Disclaimer: It was a throwaway project to test that hypothesis <a href="https://github.com/voxmedia/Transcriber/issues">see issues in repo for reasons why it’s not distribution ready</a>. However, these have been addressed and improved in <a href="https://autoedit.io">autoEdit 2</a>.</p>
<p>This project also uses <a href="https://nwjs.io/">nwjs</a> (formerly &quot;node web-kit&quot;) while autoEdit was later refactored to use electron. But for the purpose of adding support for ffmpeg, this is irrelevant for now.</p>
<p>Back to our point, in this use case, when working with STT a common problem is converting audio or video to the audio file format that meets the specs of the STT API. In this working prototype, I had a module to do just that <a href="https://github.com/voxmedia/Transcriber/blob/master/video_to_audio_processing/video_to_audio.js"><code>video_to_audio.js</code></a>.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">/*<br>* convert video file to audio<br>* use node fluent ffmpeg (to be able to specify path to ffmpeg binary)<br>* and to avoid security issues associated with calling child process making system calls to ffmpeg.<br>* IBM API Audio settings from sam's github gist https://gist.github.com/antiboredom/9bed969c8b2f89ea4b6c#file-transcribe-js-L18<br>*<br>*/</span><br><br><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> ffmpeg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fluent-ffmpeg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Setting ffmpeg path to ffmpeg binary for os x so that ffmpeg can be packaged with the app.</span><br>ffmpeg<span class="token punctuation">.</span><span class="token function">setFfmpegPath</span><span class="token punctuation">(</span><span class="token string">"./bin/ffmpeg"</span><span class="token punctuation">)</span><br><span class="token comment">//because of the nature of ffmpeg, this can take both audio or video files as input</span><br><span class="token keyword">function</span> <span class="token function">convertToWav</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span>output<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span>  audioBitRateFor100mbSize<span class="token operator">=</span><span class="token string">'2'</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> aud_file <span class="token operator">=</span>  output<span class="token punctuation">;</span><br>  <span class="token keyword">var</span> comand <span class="token operator">=</span> <span class="token function">ffmpeg</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">noVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">audioCodec</span><span class="token punctuation">(</span><span class="token string">'pcm_s16le'</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">audioChannels</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">audioFrequency</span><span class="token punctuation">(</span><span class="token number">16000</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">audioBitrate</span><span class="token punctuation">(</span>audioBitRateFor100mbSize<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><br>                <span class="token comment">// .videoBitrate(audioBitRateFor100mbSize, true)</span><br>                <span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>aud_file<span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">progress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                  <span class="token comment">//  progress // {"frames":null,"currentFps":null,"currentKbps":256,"targetSize":204871,"timemark":"01:49:15.90"}</span><br>                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Processing: '</span> <span class="token operator">+</span> progress<span class="token punctuation">.</span>timemark <span class="token operator">+</span> <span class="token string">' done '</span> <span class="token operator">+</span> progress<span class="token punctuation">.</span>targetSize<span class="token operator">+</span><span class="token string">' kilobytes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span><br>                <span class="token comment">//listener must be a function, so to return the callback wrapping it inside a function</span><br>                  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>                    <span class="token function">cb</span><span class="token punctuation">(</span>aud_file<span class="token punctuation">)</span><br>                  <span class="token punctuation">}</span><br>                  <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Finished processing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                    <span class="token punctuation">}</span><br>                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> convertToWav<span class="token punctuation">;</span><br></code></pre>
<p>As you can see <a href="https://github.com/voxmedia/Transcriber/blob/master/video_to_audio_processing/video_to_audio.js#L12">at line 12</a> we are setting the path to the ffmpeg binary.</p>
<pre class="language-js"><code class="language-js">ffmpeg<span class="token punctuation">.</span><span class="token function">setFfmpegPath</span><span class="token punctuation">(</span><span class="token string">"./bin/ffmpeg"</span><span class="token punctuation">)</span></code></pre>
<p>Where <a href="https://github.com/voxmedia/Transcriber/tree/master/bin"><code>&quot;./bin/ffmpeg&quot;</code> corresponds to the path</a> where the ffmpeg binary for Mac OS X is located in the repository. When packaging/building the app for distribution this binary will be included with it.</p>
<h3>Advantages and disadvantages</h3>
<p>On the plus side this is a pretty straightforward implementation but some of its limitations are that it does not account for cross-platform distribution eg if you are making if for Mac Linux and PC, or even different type of architecture, such as 64 or 32 bits if you were to support both newer and older computers. To do so you’d need a way to recognize the os and architecture and use the right binary.</p>
<p>Let’s consider a more involved example that gives more flexibility.</p>
<h2>Cross platform setup example: <a href="https://autoedit.io">autoEdit 2</a></h2>
<p>In <a href="https://autoedit.io">autoEdit</a> the audio/video conversion to obtain an audio that meets the STT API specs is a bit more involved and handled with a series of components.</p>
<p>Without getting too deep into the low-level implementation, there's an <a href="https://github.com/OpenNewsLabs/autoEdit_2/tree/master/lib/interactive_transcription_generator"><code>interactive_transcription_generator</code></a> module that uses other components to create a transcription, read metadata, and create a video preview.  It delegates the communication with the STT APIs to the <a href="https://github.com/OpenNewsLabs/autoEdit_2/tree/master/lib/interactive_transcription_generator/transcriber"><code>transcriber</code></a> component. Which uses other modules to split the media into 5 minutes chunks to speed up the transcription time. Such as the <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/lib/interactive_transcription_generator/transcriber/trimmer.js#L45"><code>trimmer</code>, module which trims a video or audio file.</a> as part of this process.</p>
<p>With this overview in mind let's look at how the <code>ffmpeg</code> + <code>electron</code> integration was done in this app.</p>
<h3><code>Config.js</code> file</h3>
<p>In autoEdit, there is a <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/config.js"><code>config.js</code> file at the root of the project</a>. This module can be required anywhere in the application to access shared resources.</p>
<p>This config module contains <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/config.js#L12">the path to both ffmpeg and ffprobe binaries</a>.</p>
<p>At a minimum, this is what this module should do, require binary path from <code>ffmpeg-static</code> and make it available at the root of the project in the config module</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> ffmpegPath <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ffmpeg-static'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">;</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><br>    ffmpegPath<span class="token operator">:</span> ffmpegPath<br>    <span class="token operator">...</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h3>Packaging the ffmpeg/ffprobe binaries</h3>
<p>As you might have noticed <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/config.js#L6">the config module contains the path to ffmpeg</a> and <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/config.js#L7">to ffprobe</a>. And to do so it’s relying on an external module. <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/package.json#L121"><code>ffmpeg-static</code></a> and <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/package.json#L122"><code>ffprobe-static</code></a>.</p>
<p><code>static-ffmpeg</code> module contains pre-built binaries for ffmpeg for the various operating system.</p>
<p>This gives you the advantage that you could be developing this app on Mac, Linux, and windows, without ffmpeg on your machine and could still be developing contributing to each OS version (with a few tweaks to the build process depending on the OS).</p>
<!-- move this -->
<p>The other advantage is that if you wish you can change the ffmpeg binary that you want to ship with your electron app with a version that might have a specific set of dependencies.</p>
<!-- end move this -->
<p>In the case of autoEdit, it is a mac only app, but I tried to keep option to make windows and Linux version open as much as possible where it didn’t require a lot of extra effort to avoid it from becoming too much of an undertaking should I decide to do that in the future.</p>
<p>The key reason why I ended up <a href="https://help.github.com/articles/fork-a-repo/">forking the original</a> and creating my own version for simplicity is that as we’ll see in later section,  when packaging the app, <a href="https://github.com/electron-userland/electron-builder"><code>electron-builder</code></a> can recognise the operating system and architecture of the machine you are on,which is useful for including /excluding the binaries for that distribution.</p>
<p>But when <code>electron-builder</code> recognizes a Mac computer it recognizes it as the string <code>mac</code>. While <code>static-ffmpeg</code> uses the <a href="https://nodejs.org/api/os.html"><code>os</code></a> module <a href="https://github.com/pietrop/ffmpeg-static/blob/master/index.js#L4"><code>os.platform()</code></a> which recognises a Mac computer as the string <code>darwin</code>. (<a href="https://www.w3schools.com/nodejs/ref_os.asp"><code>os</code> module also explained in more simple terms here</a>)</p>
<p>This means that if we want to use <code>electron-builder</code> and <code>ffmpeg-static</code> to have consistent file path to the ffmpeg binary we are packing inside electron both for providing a file path to use with <code>fluent-ffmpeg</code> in our code base, as well as for including the right binary for the right os distribution and excluding the rest we need the os name for mac os x to be consistent.</p>
<p>So In my version of <code>static-ffmpeg</code> I <a href="https://github.com/pietrop/ffmpeg-static/tree/master/bin/mac/x64">changed the folder to the mac binary to be called <code>mac</code> instead of <code>darwin</code></a>. And <a href="https://github.com/pietrop/ffmpeg-static/blob/master/index.js#L6">added a bit of logic so that when <code>os</code> module recognizes it as darwin it gets assigned as <code>mac</code></a>.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><br><br><span class="token keyword">var</span> platform <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">platform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token comment">//patch for compatibilit with electron-builder, for smart built process.</span><br><span class="token keyword">if</span><span class="token punctuation">(</span>platform <span class="token operator">==</span> <span class="token string">"darwin"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>    platform <span class="token operator">=</span> <span class="token string">"mac"</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>platform <span class="token operator">==</span> <span class="token string">"win32"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>    platform <span class="token operator">=</span> <span class="token string">"win"</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>And as you can see <a href="https://github.com/pietrop/ffmpeg-static/blob/master/index.js#L8"> the same thing was done for windows to change from <code>win32</code> to <code>win</code> for the same reason.</a></p>
<p>To best understand the <code>ffmpeg-static</code>module is <a href="https://github.com/pietrop/ffmpeg-static/blob/master/index.js#L23">useful to look the part where the path to the binary is constructed</a> using the <a href="https://nodejs.org/api/path.html"><code>path</code></a> module and <a href="https://github.com/pietrop/ffmpeg-static/blob/master/index.js#L26"><code>platform</code> variable to construct the file path</a>.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> ffmpegPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><br>  __dirname<span class="token punctuation">,</span><br>  <span class="token string">'bin'</span><span class="token punctuation">,</span><br>  platform<span class="token punctuation">,</span><br>  arch<span class="token punctuation">,</span><br>  platform <span class="token operator">===</span> <span class="token string">'win'</span> <span class="token operator">?</span> <span class="token string">'ffmpeg.exe'</span> <span class="token operator">:</span> <span class="token string">'ffmpeg'</span><br><span class="token punctuation">)</span></code></pre>
<p>I did something equivalent for my version of <a href="https://github.com/pietrop/ffprobe-static"><code>ffprobe-static</code></a>.</p>
<p>However <a href="https://github.com/pietrop/ffmpeg-static/blob/master/index.js">what’s missing is the logic for the support for Linux binary in the index.js file</a> even tho <a href="https://github.com/pietrop/ffmpeg-static/tree/master/bin/linux">the binaries for Linux are in the repository</a>. Pull request welcome, should you have a use case where support for Linux is needed and want to contribute to this.</p>
<h3>Requiring the path</h3>
<p>As an example, we have seen a whirlwind overview of the autoEdit architecture for the transcription and video conversion part at the beginning of this section. As you might remember there’s a module that <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/lib/interactive_transcription_generator/transcriber/trimmer.js#L45">sets the ffmepg path, <code>trimmer.js</code></a>.</p>
<pre class="language-js"><code class="language-js">ffmpeg<span class="token punctuation">.</span><span class="token function">setFfmpegPath</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ffmpegBin<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>While the module that requires the ffmpeg path is the <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/lib/interactive_transcription_generator/index.js#L84"><code>interactive_transcription_generator</code></a> which requires it from the config module.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> ffmpegPath  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../../config.js"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ffmpegPath<span class="token punctuation">;</span></code></pre>
<p>And then passes it <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/lib/interactive_transcription_generator/index.js#L125">as a config parameter to the transcriber module</a> which then gets passed down the chain all the way to our <code>trimmer</code> module we saw in the previous section.</p>
<h3>Packaging/build electron app</h3>
<p>The problem with this setup is that we don’t want to have the binary for windows and Linux in the mac distribution as that would take up a lot of space. And we ideally want to keep our electron app as lightweight as possible.</p>
<p>In order to do that we have to add some logic to our build script to only package the binary for the os that we are building for.</p>
<p>Using <a href="https://github.com/electron-userland/electron-builder"><code>electron-builder</code></a> there is a files notation that can be used to specify these rules in <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/package.json"><code>package.json</code></a>.</p>
<p>Where the <code>${os}</code> and <code>${arch}</code> variable give you operating system(Mac, Linux, pc) and architecture (32 or 64 bits).</p>
<p>In <a href="https://github.com/OpenNewsLabs/autoEdit_2/blob/master/package.json"><code>package.json</code></a> you can set the files to include/exclude as follows.</p>
<pre class="language-json"><code class="language-json">...<br>    <span class="token property">"files"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"**/*"</span><span class="token punctuation">,</span><br>      <span class="token string">"!config/"</span><span class="token punctuation">,</span><br>      <span class="token string">"!spec/"</span><span class="token punctuation">,</span><br>      <span class="token string">"!project_page/"</span><span class="token punctuation">,</span><br>      <span class="token string">"!vendor/"</span><span class="token punctuation">,</span><br>      <span class="token string">"!docs/"</span><span class="token punctuation">,</span><br>      <span class="token string">"!dist/"</span><span class="token punctuation">,</span><br>      <span class="token string">"!assets/"</span><span class="token punctuation">,</span><br>      <span class="token string">"node_modules/ffmpeg-static/bin/${os}/${arch}/ffmpeg"</span><span class="token punctuation">,</span><br>      <span class="token string">"node_modules/ffmpeg-static/index.js"</span><span class="token punctuation">,</span><br>      <span class="token string">"node_modules/ffmpeg-static/package.json"</span><span class="token punctuation">,</span><br>      <span class="token string">"node_modules/ffprobe-static/bin/${os}/${arch}/ffmpeg"</span><span class="token punctuation">,</span><br>      <span class="token string">"node_modules/ffprobe-static/index.js"</span><span class="token punctuation">,</span><br>      <span class="token string">"node_modules/ffprobe-static/package.json"</span><br>    <span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token property">"copyright"</span><span class="token operator">:</span> <span class="token string">"2017 Pietro Passarelli"</span><span class="token punctuation">,</span><br>    <span class="token property">"mac"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"public.app-category.productivity"</span><span class="token punctuation">,</span><br>      <span class="token property">"files"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>        <span class="token string">"!node_modules/ffmpeg-static/bin/win${/*}"</span><span class="token punctuation">,</span><br>        <span class="token string">"!node_modules/ffmpeg-static/bin/linux${/*}"</span><span class="token punctuation">,</span><br>        <span class="token string">"!node_modules/ffprobe-static/bin/win${/*}"</span><span class="token punctuation">,</span><br>        <span class="token string">"!node_modules/ffprobe-static/bin/linux${/*}"</span><br>      <span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>...</code></pre>
<p>More details on this in <a href="https://www.electron.build/configuration/configuration"><code>electron-builder</code> documentation</a>.</p>
<h2>End</h2>
<p>That's it, hope this gives you an idea of how to go about adding ffmpeg in your electron app.</p>
<p>If you have any thoughts, questions, ideas, alternatives, get in touch via email or twitter <a href="https://twitter.com/pietropassarell">@pietropassarell</a>.</p>



	
</div>
        <hr>
<p class="edit-on-github-link">
	<small><a href="https://github.com/pietrop/pietrop.github.io/blob/master/./categories/ttqf/2017-11-16-ffmpeg-electron.md">Edit this page on GitHub <i class="fab fa-github"></i></a></small>
</p>
      </main>
      <footer class="footer">
    <nav>
        <ul class="contacts-list">
            <li>
                <a
                    href="mailto:pietro.passarelli@gmail.com?Subject=Hello&body=Hi Pietro, %0D%0A Was reading your website, and I've got a question..."
                    class="author-social" target="_blank" rel="noopener noreferrer">
                    <i class="far fa-envelope"></i>
                    E-mail</a> <span></span>
            </li>
            <li>
                <a 
                    href="https://twitter.com/pietropassarell" target="_blank" rel="noopener noreferrer"> 
                    <i class="fab fa-twitter"></i> Twitter</a>
            </li>
            <li>
                <a 
                    href="https://github.com/pietrop" target="_blank" rel="noopener noreferrer">
                    <i class="fab fa-github"></i> GitHub</a>
            </li>
            <li>
                <a 
                    href="https://uk.linkedin.com/in/pietropassarelli" target="_blank"
                    rel="noopener noreferrer"><i class="fab fa-linkedin-in"></i> Linkedin</a>
            </li>

            <li>
                <a 
                    href="https://www.instagram.com/pietro.ps" target="_blank"
                    rel="noopener noreferrer"><i class="fab fa-instagram"></i> Instagram</a>
            </li>
        </ul>
    </nav>
</footer>
    </div>
  </div>
  <script>
    // Logic to adjust syntax highlighting based on whether dark mode is on 
    // in the system or not
    const prismEl = document.querySelector('#prism-css');
    const DARK = 'dark';
    const LIGHT = 'light';
    const PRISM_LIGHT_URL = "https://unpkg.com/prismjs@1.20.0/themes/prism.css";
    // https://unpkg.com/browse/prismjs@0.0.1/themes/ coy, dark, funky,okaidia, tomorrow, twilight
    const PRISM_DARK_URL = "https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css"

    function init() {
      const DARK = 'dark';
      const LIGHT = 'light';
      const isSystemDarkMode = matchMedia &&
        matchMedia('(prefers-color-scheme: dark)').matches;

      if (isSystemDarkMode) {
        prismEl.href = PRISM_DARK_URL;
      }

      // Event listener to change with system change
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        const changedColourScheme = e.matches ? DARK : LIGHT;
        if (changedColourScheme === DARK) {
          prismEl.href = PRISM_DARK_URL;
        } else {
          prismEl.href = PRISM_LIGHT_URL;
        }
      });
    }

    init();
  </script>
</body>

</html>